{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stalkineitor 2.0</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="{% static 'css/floating_timer.css' %}">
    <link rel="stylesheet" href="{% static 'css/train_blind_mode.css' %}">
    <style>
        .rating-pill {
            position: relative;
            display: inline-block;
            overflow: hidden;
            border: 1px solid var(--rating-color);
            color: var(--rating-text);
        }
        .rating-pill::before {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: var(--rating-fill);
            background: var(--rating-color);
            opacity: 0.85;
        }
        .rating-pill > span {
            position: relative;
            z-index: 1;
        }
        .solver-loaded {
            animation: solverFlash 1.2s ease-out 1;
        }
        @keyframes solverFlash {
            0% {
                background-color: rgba(16, 185, 129, 0.18);
            }
            100% {
                background-color: transparent;
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 font-sans">
    <nav class="relative z-50 bg-gradient-to-r from-slate-950 via-slate-900 to-slate-950 px-4 py-3 text-slate-100 shadow-md border-b border-slate-800">
        <div class="container mx-auto flex flex-wrap items-center justify-between gap-3">
            <a href="{% url 'dashboard' %}" class="flex items-center gap-3">
                <img src="{% static 'img/logo.png' %}" alt="Stalkineitor" class="h-14 w-14 translate-x-1 translate-y-1 rounded-2xl bg-slate-950 object-cover shadow-sm">
                <span class="text-2xl font-bold tracking-tight leading-none mt-0.5">Stalkineitor 2.0</span>
            </a>

            <div class="hidden md:flex flex-wrap items-center gap-2">
                <a href="{% url 'dashboard' %}" class="px-4 py-2 rounded-full text-sm border {% if request.resolver_match.url_name == 'dashboard' %}border-indigo-500/60 bg-indigo-500/20 text-indigo-100{% else %}border-slate-700 bg-slate-900/60 hover:bg-slate-800{% endif %}">Dashboard</a>
                <a href="{% url 'ranking' %}" class="px-4 py-2 rounded-full text-sm border {% if request.resolver_match.url_name == 'ranking' %}border-indigo-500/60 bg-indigo-500/20 text-indigo-100{% else %}border-slate-700 bg-slate-900/60 hover:bg-slate-800{% endif %}">Ranking</a>
                <a href="{% url 'train' %}" class="px-4 py-2 rounded-full text-sm border {% if request.resolver_match.url_name == 'train' %}border-indigo-500/60 bg-indigo-500/20 text-indigo-100{% else %}border-slate-700 bg-slate-900/60 hover:bg-slate-800{% endif %}">Treino</a>
                <a href="{% url 'contests_overview' %}" class="px-4 py-2 rounded-full text-sm border {% if request.resolver_match.url_name == 'contests_overview' %}border-indigo-500/60 bg-indigo-500/20 text-indigo-100{% else %}border-slate-700 bg-slate-900/60 hover:bg-slate-800{% endif %}">Contests</a>

                {% if request.user.is_superuser %}
                <details class="relative">
                    <summary class="cursor-pointer list-none px-4 py-2 rounded-full text-sm border border-slate-700 bg-slate-900/60 hover:bg-slate-800">
                        Ferramentas
                    </summary>
                    <div class="absolute right-0 mt-2 w-52 rounded-xl border border-slate-700 bg-slate-950 p-2 text-sm shadow-xl z-50">
                        <a href="{% url 'admin_panel' %}" class="block rounded-lg px-3 py-2 text-slate-200 hover:bg-slate-800">Painel ADM Nutella</a>
                        <a href="{% url 'admin_users' %}" class="block rounded-lg px-3 py-2 text-slate-200 hover:bg-slate-800">Usuários</a>
                        <a href="{% url 'add_student' %}" class="block rounded-lg px-3 py-2 text-slate-200 hover:bg-slate-800">Adicionar aluno</a>
                        <a href="/admin/" target="_blank" class="block rounded-lg px-3 py-2 text-slate-200 hover:bg-slate-800">Painel ADM Raiz</a>
                    </div>
                </details>
                {% endif %}
            </div>

            <div class="hidden md:flex flex-wrap items-center gap-2">
                {% if request.user.is_authenticated %}
                    <a href="{% url 'user_profile' request.user.username %}?tab=settings" class="px-4 py-2 rounded-full text-sm border border-slate-700 bg-slate-900/60 hover:bg-slate-800">Minha Conta</a>
                    <a href="{% url 'logout' %}" class="px-4 py-2 rounded-full text-sm border border-rose-500/40 bg-rose-500/10 text-rose-100 hover:bg-rose-500/20">Sair</a>
                {% else %}
                    <a href="{% url 'login' %}" class="px-4 py-2 rounded-full text-sm border border-slate-700 bg-slate-900/60 hover:bg-slate-800">Entrar</a>
                    <a href="{% url 'signup' %}" class="px-4 py-2 rounded-full text-sm border border-emerald-500/40 bg-emerald-500/15 text-emerald-100 hover:bg-emerald-500/25">Criar conta</a>
                {% endif %}
            </div>

            <button id="nav-toggle" class="md:hidden inline-flex items-center justify-center rounded-full border border-slate-700 bg-slate-900/60 p-2 text-slate-200 hover:bg-slate-800" aria-expanded="false" aria-controls="mobile-nav">
                <span class="sr-only">Abrir menu</span>
                <svg id="nav-icon-open" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5">
                    <path fill-rule="evenodd" d="M3.75 5.25h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1 0-1.5Zm0 6h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1 0-1.5Zm0 6h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1 0-1.5Z" clip-rule="evenodd" />
                </svg>
                <svg id="nav-icon-close" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="hidden h-5 w-5">
                    <path fill-rule="evenodd" d="M6.28 5.22a.75.75 0 0 1 1.06 0L12 9.88l4.66-4.66a.75.75 0 1 1 1.06 1.06L13.06 10.94l4.66 4.66a.75.75 0 1 1-1.06 1.06L12 12l-4.66 4.66a.75.75 0 0 1-1.06-1.06l4.66-4.66-4.66-4.66a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>

        <div id="mobile-nav" class="md:hidden hidden border-t border-slate-800 bg-slate-950/95">
            <div class="container mx-auto space-y-4 px-4 py-4 text-sm text-slate-200">
                <div>
                    <div class="text-[11px] uppercase tracking-wide text-slate-500 mb-2">Principal</div>
                    <div class="grid gap-2">
                        <a href="{% url 'dashboard' %}" class="rounded-lg border border-slate-800 bg-slate-900/60 px-3 py-2">Dashboard</a>
                        <a href="{% url 'ranking' %}" class="rounded-lg border border-slate-800 bg-slate-900/60 px-3 py-2">Ranking</a>
                        <a href="{% url 'train' %}" class="rounded-lg border border-slate-800 bg-slate-900/60 px-3 py-2">Treino</a>
                        <a href="{% url 'contests_overview' %}" class="rounded-lg border border-slate-800 bg-slate-900/60 px-3 py-2">Contests</a>
                    </div>
                </div>
                {% if request.user.is_superuser %}
                <div>
                    <div class="text-[11px] uppercase tracking-wide text-slate-500 mb-2">Ferramentas</div>
                    <div class="grid gap-2">
                        <a href="{% url 'admin_panel' %}" class="rounded-lg border border-slate-800 bg-slate-900/60 px-3 py-2">Painel ADM Nutella</a>
                        <a href="{% url 'admin_users' %}" class="rounded-lg border border-slate-800 bg-slate-900/60 px-3 py-2">Usuários</a>
                        <a href="{% url 'add_student' %}" class="rounded-lg border border-slate-800 bg-slate-900/60 px-3 py-2">Adicionar aluno</a>
                        <a href="/admin/" target="_blank" class="rounded-lg border border-slate-800 bg-slate-900/60 px-3 py-2">Painel ADM Raiz</a>
                    </div>
                </div>
                {% endif %}
                <div>
                    <div class="text-[11px] uppercase tracking-wide text-slate-500 mb-2">Conta</div>
                    <div class="grid gap-2">
                        {% if request.user.is_authenticated %}
                            <a href="{% url 'user_profile' request.user.username %}?tab=settings" class="rounded-lg border border-slate-800 bg-slate-900/60 px-3 py-2">Minha Conta</a>
                            <a href="{% url 'logout' %}" class="rounded-lg border border-rose-500/40 bg-rose-500/10 px-3 py-2 text-rose-100">Sair</a>
                        {% else %}
                            <a href="{% url 'login' %}" class="rounded-lg border border-slate-800 bg-slate-900/60 px-3 py-2">Entrar</a>
                            <a href="{% url 'signup' %}" class="rounded-lg border border-emerald-500/40 bg-emerald-500/15 px-3 py-2 text-emerald-100">Criar conta</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4">
        {% block content %}{% endblock %}
    </main>

    <div id="modal-root"></div>

    <!-- Floating train timer (only visible when #train-page[data-train-timer="1"] exists) -->
    <div id="floating-train-timer" data-minimized="0" data-running="0" data-alarm="1" data-readonly="0" class="hidden fixed bottom-4 right-4 z-[9999] select-none">
        <div id="ft-toast" class="hidden mb-3 w-[calc(100vw-2rem)] max-w-xs rounded-2xl border border-slate-700/60 bg-slate-950/95 p-3 shadow-2xl backdrop-blur">
            <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                    <div class="text-[11px] uppercase tracking-wide text-slate-500">Cronômetro</div>
                    <div id="ft-toast-msg" class="mt-1 text-sm font-semibold text-slate-100">Tempo!</div>
                </div>
                <button id="ft-toast-close" type="button" aria-label="Fechar aviso"
                        class="min-h-[44px] min-w-[44px] rounded-xl border border-slate-700 bg-slate-900/60 text-slate-200 hover:bg-slate-800">
                    <svg viewBox="0 0 24 24" class="mx-auto h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M6 6l12 12"></path>
                        <path d="M18 6l-12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="ft-toast-actions" class="mt-3 flex flex-wrap gap-2">
                <button id="ft-toast-add5" type="button"
                        class="min-h-[44px] rounded-xl border border-slate-700 bg-slate-900/60 px-3 text-xs font-semibold text-slate-200 hover:bg-slate-800">
                    +5 min
                </button>
                <button id="ft-toast-continue" type="button"
                        class="min-h-[44px] rounded-xl border border-indigo-500/40 bg-indigo-500/15 px-3 text-xs font-semibold text-indigo-100 hover:bg-indigo-500/25">
                    Continuar
                </button>
                <button id="ft-toast-end-session" type="button"
                        class="hidden min-h-[44px] rounded-xl border border-rose-500/40 bg-rose-500/10 px-3 text-xs font-semibold text-rose-100 hover:bg-rose-500/20">
                    Encerrar sessão
                </button>
                <button id="ft-toast-open-session" type="button"
                        class="hidden min-h-[44px] rounded-xl border border-emerald-500/40 bg-emerald-500/10 px-3 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/20">
                    Voltar para sessão
                </button>
            </div>
        </div>

        <div id="ft-card" class="ft-clock" data-view="compact">
            <div id="ft-dial" class="ft-dial">
                <svg class="pointer-events-none absolute inset-0 h-full w-full" viewBox="0 0 100 100" aria-hidden="true">
                    <circle cx="50" cy="50" r="46.5" fill="none" stroke="rgba(148,163,184,0.28)" stroke-width="2.6" />
                    <circle id="ft-ring-progress" cx="50" cy="50" r="46.5" fill="none" stroke="#4f46e5" stroke-width="2.9" stroke-linecap="round"
                            transform="rotate(-90 50 50)" stroke-dasharray="292" stroke-dashoffset="0" />
                    <g opacity="0.55">
                        <line x1="50" y1="5.5" x2="50" y2="10.5" stroke="rgba(226,232,240,0.6)" stroke-width="1.7" stroke-linecap="round" />
                        <line x1="50" y1="5.5" x2="50" y2="10.5" stroke="rgba(226,232,240,0.32)" stroke-width="1.2" stroke-linecap="round" transform="rotate(30 50 50)" />
                        <line x1="50" y1="5.5" x2="50" y2="10.5" stroke="rgba(226,232,240,0.32)" stroke-width="1.2" stroke-linecap="round" transform="rotate(60 50 50)" />
                        <line x1="50" y1="5.5" x2="50" y2="10.5" stroke="rgba(226,232,240,0.6)" stroke-width="1.7" stroke-linecap="round" transform="rotate(90 50 50)" />
                        <line x1="50" y1="5.5" x2="50" y2="10.5" stroke="rgba(226,232,240,0.32)" stroke-width="1.2" stroke-linecap="round" transform="rotate(120 50 50)" />
                        <line x1="50" y1="5.5" x2="50" y2="10.5" stroke="rgba(226,232,240,0.32)" stroke-width="1.2" stroke-linecap="round" transform="rotate(150 50 50)" />
                        <line x1="50" y1="5.5" x2="50" y2="10.5" stroke="rgba(226,232,240,0.6)" stroke-width="1.7" stroke-linecap="round" transform="rotate(180 50 50)" />
                        <line x1="50" y1="5.5" x2="50" y2="10.5" stroke="rgba(226,232,240,0.32)" stroke-width="1.2" stroke-linecap="round" transform="rotate(210 50 50)" />
                        <line x1="50" y1="5.5" x2="50" y2="10.5" stroke="rgba(226,232,240,0.32)" stroke-width="1.2" stroke-linecap="round" transform="rotate(240 50 50)" />
                        <line x1="50" y1="5.5" x2="50" y2="10.5" stroke="rgba(226,232,240,0.6)" stroke-width="1.7" stroke-linecap="round" transform="rotate(270 50 50)" />
                        <line x1="50" y1="5.5" x2="50" y2="10.5" stroke="rgba(226,232,240,0.32)" stroke-width="1.2" stroke-linecap="round" transform="rotate(300 50 50)" />
                        <line x1="50" y1="5.5" x2="50" y2="10.5" stroke="rgba(226,232,240,0.32)" stroke-width="1.2" stroke-linecap="round" transform="rotate(330 50 50)" />
                    </g>
                    <circle cx="50" cy="4.7" r="1.25" fill="rgba(129,140,248,0.92)" />
                </svg>

                <div class="ft-dial-inner">
                    <div class="ft-top">
                        <button id="ft-alarm" type="button" aria-label="Alternar alarme" class="ft-icon-btn">
                            <svg id="ft-icon-bell-on" viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <path d="M18 8a6 6 0 10-12 0c0 7-3 7-3 7h18s-3 0-3-7"></path>
                                <path d="M13.73 21a2 2 0 01-3.46 0"></path>
                            </svg>
                            <svg id="ft-icon-bell-off" viewBox="0 0 24 24" class="h-5 w-5 opacity-50" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <path d="M18 8a6 6 0 10-12 0c0 7-3 7-3 7h18s-3 0-3-7"></path>
                                <path d="M13.73 21a2 2 0 01-3.46 0"></path>
                            </svg>
                        </button>

                        <div class="ft-sub">
                            <div id="ft-sub-title" class="ft-sub-title">Sessão</div>
                            <div id="ft-sub-preset" class="ft-sub-preset">90 min</div>
                        </div>

                        <div class="ft-top-actions">
                            <button id="ft-open-session" type="button" aria-label="Abrir sessão vinculada" class="ft-icon-btn hidden">
                                <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path d="M14 3h7v7"></path>
                                    <path d="M10 14L21 3"></path>
                                    <path d="M21 14v7h-7"></path>
                                    <path d="M3 10V3h7"></path>
                                    <path d="M3 21l7-7"></path>
                                </svg>
                            </button>
                            <button id="ft-expand" type="button" aria-label="Expandir ajustes" class="ft-icon-btn">
                                <svg id="ft-icon-expand" viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path d="M6 9l6 6 6-6"></path>
                                </svg>
                                <svg id="ft-icon-compact" viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path d="M6 15l6-6 6 6"></path>
                                </svg>
                            </button>
                            <button id="ft-minimize" type="button" aria-label="Minimizar" class="ft-icon-btn">
                                <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true">
                                    <path d="M6 12h12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="ft-expanded ft-adjust">
                        <button id="ft-minus" type="button" aria-label="Diminuir 1 minuto" class="ft-mini-btn">
                            <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" aria-hidden="true">
                                <path d="M6 12h12"></path>
                            </svg>
                        </button>
                        <div class="ft-adjust-label">1 min</div>
                        <button id="ft-plus" type="button" aria-label="Aumentar 1 minuto" class="ft-mini-btn">
                            <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <path d="M12 6v12"></path>
                                <path d="M6 12h12"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="ft-time-wrap">
                        <div id="ft-time" aria-live="polite" class="ft-time">00:00</div>
                    </div>

                    <div class="ft-pacing">
                        <div id="ft-readonly" class="ft-readonly hidden">Timer ativo em outra aba</div>
                    </div>

                    <button id="ft-mini-toggle" type="button" aria-label="Iniciar/Pausar" class="ft-mini-toggle ft-minimized-only">
                        <svg id="ft-icon-play-mini" viewBox="0 0 24 24" class="h-5 w-5" fill="currentColor" aria-hidden="true">
                            <path d="M8 5v14l11-7-11-7z"></path>
                        </svg>
                        <svg id="ft-icon-pause-mini" viewBox="0 0 24 24" class="h-5 w-5" fill="currentColor" aria-hidden="true">
                            <path d="M6 5h4v14H6zM14 5h4v14h-4z"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="ft-actions ft-actions-main">
                <button id="ft-start-pause" type="button" aria-label="Iniciar/Pausar" class="ft-action-primary">
                    <svg id="ft-icon-play" viewBox="0 0 24 24" class="h-7 w-7" fill="currentColor" aria-hidden="true">
                        <path d="M8 5v14l11-7-11-7z"></path>
                    </svg>
                    <svg id="ft-icon-pause" viewBox="0 0 24 24" class="h-7 w-7" fill="currentColor" aria-hidden="true">
                        <path d="M6 5h4v14H6zM14 5h4v14h-4z"></path>
                    </svg>
                </button>
                <button id="ft-reset" type="button" aria-label="Resetar" class="ft-action-secondary">
                    <svg viewBox="0 0 24 24" class="h-7 w-7" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M21 12a9 9 0 1 1-2.64-6.36"></path>
                        <path d="M21 3v6h-6"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <script>
        document.body.addEventListener('htmx:configRequest', (event) => {
            event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
        });

        function closeModalRoot() {
            const modalRoot = document.getElementById('modal-root');
            if (modalRoot) modalRoot.innerHTML = '';
        }

        function highlightCodeBlocks() {
            if (!window.hljs) return;
            hljs.highlightAll();
        }

        document.addEventListener('DOMContentLoaded', () => highlightCodeBlocks());
        document.body.addEventListener('htmx:afterSwap', (event) => {
            highlightCodeBlocks();
        });

        const navToggle = document.getElementById('nav-toggle');
        const mobileNav = document.getElementById('mobile-nav');
        const navIconOpen = document.getElementById('nav-icon-open');
        const navIconClose = document.getElementById('nav-icon-close');
        if (navToggle && mobileNav) {
            navToggle.addEventListener('click', () => {
                const isOpen = !mobileNav.classList.contains('hidden');
                mobileNav.classList.toggle('hidden');
                navToggle.setAttribute('aria-expanded', String(!isOpen));
                if (navIconOpen && navIconClose) {
                    navIconOpen.classList.toggle('hidden');
                    navIconClose.classList.toggle('hidden');
                }
            });
        }
    </script>

    <script src="{% static 'js/floating_timer.js' %}"></script>
    <script src="{% static 'js/train_blind_mode.js' %}"></script>
</body>
</html>
