{% extends 'base.html' %}

{% block content %}
<section class="mx-auto mt-10 max-w-6xl space-y-6">
    <div class="flex items-center justify-between gap-4">
        <h1 class="text-2xl font-bold text-slate-100">Adicionar Aluno</h1>
        <a href="{% url 'dashboard' %}" class="rounded-lg border border-slate-700 bg-slate-900/60 px-3 py-2 text-sm text-slate-200 hover:bg-slate-800">
            Voltar
        </a>
    </div>

    {% if error %}
        <div class="rounded-xl border border-rose-500/40 bg-rose-500/10 px-4 py-3 text-sm text-rose-200" role="alert">
            {{ error }}
        </div>
    {% endif %}
    {% if success %}
        <div class="rounded-xl border border-emerald-500/40 bg-emerald-500/10 px-4 py-3 text-sm text-emerald-200" role="alert">
            {{ success }}
        </div>
    {% endif %}

    <div class="grid gap-6 lg:grid-cols-2">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
            <h2 class="text-lg font-semibold text-slate-100">Cadastrar aluno</h2>
            <p class="text-xs text-slate-400">Cria o usuário no sistema e perfil competitivo.</p>

            <form method="post" class="mt-4 space-y-4">
                {% csrf_token %}
                <input type="hidden" name="action" value="create_student">

                <div>
                    <label class="mb-1 block text-sm font-bold text-slate-300" for="username">
                        Nome de Usuário (Sistema)
                    </label>
                    <input
                        class="w-full rounded border border-slate-600 bg-slate-900 px-3 py-2 text-slate-100 focus:border-indigo-500 focus:outline-none"
                        id="username"
                        name="username"
                        type="text"
                        required
                        value="{{ form_data.username|default:'' }}"
                        placeholder="Ex: lobomelanciaauuuu">
                </div>

                <div>
                    <label class="mb-1 block text-sm font-bold text-slate-300" for="cf_handle">
                        Handle Codeforces
                    </label>
                    <input
                        class="w-full rounded border border-slate-600 bg-slate-900 px-3 py-2 text-slate-100 focus:border-indigo-500 focus:outline-none"
                        id="cf_handle"
                        name="cf_handle"
                        type="text"
                        value="{{ form_data.cf_handle|default:'' }}"
                        placeholder="Ex: shirogarouomito">
                </div>

                <div>
                    <label class="mb-1 block text-sm font-bold text-slate-300" for="ac_handle">
                        Handle AtCoder
                    </label>
                    <input
                        class="w-full rounded border border-slate-600 bg-slate-900 px-3 py-2 text-slate-100 focus:border-indigo-500 focus:outline-none"
                        id="ac_handle"
                        name="ac_handle"
                        type="text"
                        value="{{ form_data.ac_handle|default:'' }}"
                        placeholder="Ex: garoushiro">
                </div>

                <div class="rounded-lg border border-rose-500/30 bg-rose-500/5 p-4">
                    <label class="flex items-center gap-2 text-sm font-semibold text-rose-100">
                        <input
                            type="checkbox"
                            name="mark_as_villain"
                            value="1"
                            class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-rose-500 focus:ring-rose-500"
                            {% if form_data.mark_as_villain %}checked{% endif %}>
                        Marcar usuário como vilão
                    </label>
                    <div class="mt-3">
                        <label class="mb-1 block text-xs font-semibold text-rose-200" for="villain_group_id">
                            Grupo de "Vilões" (opcional)
                        </label>
                        <select
                            id="villain_group_id"
                            name="villain_group_id"
                            class="w-full rounded border border-slate-600 bg-slate-900 px-3 py-2 text-sm text-slate-100 focus:border-rose-500 focus:outline-none">
                            <option value="">Grupo padrão: Grupo de "Vilões"</option>
                            {% for item in villain_groups %}
                                <option value="{{ item.group.id }}" {% if form_data.villain_group_id|stringformat:"s" == item.group.id|stringformat:"s" %}selected{% endif %}>
                                    {{ item.group.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-[11px] text-slate-400">Selecione um grupo existente ou deixe no padrão.</p>
                    </div>
                </div>

                <button class="w-full rounded-lg border border-indigo-500/40 bg-indigo-500/20 px-4 py-2 text-sm font-semibold text-indigo-100 hover:bg-indigo-500/30" type="submit">
                    Cadastrar
                </button>
            </form>
        </div>

        <div id="villain-groups" class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
            <h2 class="text-lg font-semibold text-slate-100">Criar grupo de "Vilões"</h2>
            <p class="text-xs text-slate-400">Crie grupos para esconder usuários do ranking por categoria.</p>

            <form method="post" class="mt-4 space-y-3">
                {% csrf_token %}
                <input type="hidden" name="action" value="create_villain_group">
                <div>
                    <label class="mb-1 block text-xs font-semibold text-slate-300">Nome do grupo</label>
                    <input
                        name="group_name"
                        type="text"
                        required
                        maxlength="80"
                        class="w-full rounded border border-slate-600 bg-slate-900 px-3 py-2 text-sm text-slate-100 focus:border-rose-500 focus:outline-none"
                        placeholder='Ex: "Vilões" da Semana'>
                </div>
                <div>
                    <label class="mb-1 block text-xs font-semibold text-slate-300">Cor (#RRGGBB)</label>
                    <div class="js-color-field space-y-2">
                        <div class="grid grid-cols-[minmax(0,1fr)_auto] gap-2">
                            <input
                                name="group_color"
                                type="text"
                                value="#DC2626"
                                data-color-hex
                                class="w-full rounded border border-slate-600 bg-slate-900 px-3 py-2 text-sm text-slate-100 focus:border-rose-500 focus:outline-none">
                            <input
                                type="color"
                                value="#DC2626"
                                data-color-picker
                                class="h-10 w-12 rounded border border-slate-600 bg-slate-900 p-1">
                        </div>
                        <div class="flex items-center gap-2 text-[11px] text-slate-400">
                            <span data-color-swatch class="h-3 w-3 rounded-full border border-slate-500/50"></span>
                            <span data-color-rgb>RGB(220, 38, 38)</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="w-full rounded-lg border border-rose-500/40 bg-rose-500/10 px-4 py-2 text-sm font-semibold text-rose-100 hover:bg-rose-500/20">
                    Criar grupo de "Vilões"
                </button>
            </form>

            <div class="mt-5 grid grid-cols-2 gap-3 text-sm">
                <div class="rounded-lg border border-slate-700 bg-slate-950/70 p-3">
                    <div class="text-xs text-slate-500">Grupos de "Vilões"</div>
                    <div class="mt-1 text-xl font-bold text-slate-100">{{ villain_group_total }}</div>
                </div>
                <div class="rounded-lg border border-slate-700 bg-slate-950/70 p-3">
                    <div class="text-xs text-slate-500">Usuários em grupos</div>
                    <div class="mt-1 text-xl font-bold text-slate-100">{{ villain_members_total }}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <h2 class="text-lg font-semibold text-slate-100">Gerenciar grupos de "Vilões"</h2>
        <p class="text-xs text-slate-400">Atualize grupo, adicione/remova usuários e exclua grupos quando necessário.</p>

        <div class="mt-4 space-y-4">
            {% for item in villain_groups %}
                <div class="rounded-xl border border-slate-700 bg-slate-950/70 p-4">
                    <div class="flex flex-wrap items-center justify-between gap-2">
                        <div class="text-sm font-semibold text-slate-100">{{ item.group.name }}</div>
                        <span class="rounded-full border border-slate-600 bg-slate-900 px-2 py-1 text-xs text-slate-300">
                            {{ item.members|length }} membro(s)
                        </span>
                    </div>

                    <form method="post" class="mt-3 grid gap-2 md:grid-cols-3">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_villain_group">
                        <input type="hidden" name="group_id" value="{{ item.group.id }}">
                        <input
                            name="group_name"
                            type="text"
                            value="{{ item.group.name }}"
                            maxlength="80"
                            class="rounded border border-slate-600 bg-slate-900 px-3 py-2 text-sm text-slate-100 focus:border-indigo-500 focus:outline-none">
                        <div class="js-color-field space-y-2">
                            <div class="grid grid-cols-[minmax(0,1fr)_auto] gap-2">
                                <input
                                    name="group_color"
                                    type="text"
                                    value="{{ item.group.color }}"
                                    data-color-hex
                                    class="rounded border border-slate-600 bg-slate-900 px-3 py-2 text-sm text-slate-100 focus:border-indigo-500 focus:outline-none">
                                <input
                                    type="color"
                                    value="{{ item.group.color }}"
                                    data-color-picker
                                    class="h-10 w-12 rounded border border-slate-600 bg-slate-900 p-1">
                            </div>
                            <div class="flex items-center gap-2 text-[11px] text-slate-400">
                                <span data-color-swatch class="h-3 w-3 rounded-full border border-slate-500/50"></span>
                                <span data-color-rgb></span>
                            </div>
                        </div>
                        <button type="submit" class="rounded border border-indigo-500/40 bg-indigo-500/15 px-3 py-2 text-sm text-indigo-100 hover:bg-indigo-500/25">
                            Salvar grupo
                        </button>
                    </form>

                    <form method="post" class="mt-3 grid gap-2 md:grid-cols-4">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add_user_to_villain_group">
                        <input type="hidden" name="group_id" value="{{ item.group.id }}">
                        <input
                            name="target_username"
                            type="text"
                            placeholder="Username para adicionar"
                            class="md:col-span-3 rounded border border-slate-600 bg-slate-900 px-3 py-2 text-sm text-slate-100 focus:border-rose-500 focus:outline-none">
                        <button type="submit" class="rounded border border-rose-500/40 bg-rose-500/10 px-3 py-2 text-sm text-rose-100 hover:bg-rose-500/20">
                            Adicionar usuário
                        </button>
                    </form>

                    <div class="mt-3">
                        <div class="mb-2 text-xs font-semibold text-slate-400">Membros</div>
                        <div class="flex flex-wrap gap-2">
                            {% for member in item.members %}
                                <div class="inline-flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-1 text-xs text-slate-200">
                                    <span>{{ member.username }}</span>
                                    <span class="rounded-full border px-2 py-0.5 text-[10px] {{ member.origin_pill_class }}" title="{{ member.origin_title }}">
                                        {{ member.origin_label }}
                                    </span>
                                    <form method="post" class="inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="remove_user_from_villain_group">
                                        <input type="hidden" name="group_id" value="{{ item.group.id }}">
                                        <input type="hidden" name="user_id" value="{{ member.id }}">
                                        <button type="submit" class="text-rose-300 hover:text-rose-200" title="Remover {{ member.username }}">
                                            remover
                                        </button>
                                    </form>
                                </div>
                            {% empty %}
                                <span class="text-xs text-slate-500">Sem membros neste grupo.</span>
                            {% endfor %}
                        </div>
                    </div>

                    <form method="post" class="mt-4 text-right" onsubmit="return confirm('Excluir o grupo {{ item.group.name }}?');">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete_villain_group">
                        <input type="hidden" name="group_id" value="{{ item.group.id }}">
                        <button type="submit" class="rounded border border-rose-500/40 bg-rose-500/10 px-3 py-2 text-xs font-semibold text-rose-100 hover:bg-rose-500/20">
                            Excluir grupo
                        </button>
                    </form>
                </div>
            {% empty %}
                <div class="rounded-xl border border-slate-700 bg-slate-950/70 p-4 text-sm text-slate-400">
                    Nenhum grupo de "Vilões" criado ainda.
                </div>
            {% endfor %}
        </div>
    </div>
</section>

<script>
    (() => {
        const wrappers = document.querySelectorAll('.js-color-field');
        if (!wrappers.length) return;

        const normalizeHex = (value) => {
            const raw = (value || '').trim();
            const withHash = raw.startsWith('#') ? raw : `#${raw}`;
            if (!/^#[0-9A-Fa-f]{6}$/.test(withHash)) {
                return null;
            }
            return withHash.toUpperCase();
        };

        const hexToRgbLabel = (hex) => {
            const r = Number.parseInt(hex.slice(1, 3), 16);
            const g = Number.parseInt(hex.slice(3, 5), 16);
            const b = Number.parseInt(hex.slice(5, 7), 16);
            return `RGB(${r}, ${g}, ${b})`;
        };

        wrappers.forEach((wrapper) => {
            const hexInput = wrapper.querySelector('[data-color-hex]');
            const pickerInput = wrapper.querySelector('[data-color-picker]');
            const swatch = wrapper.querySelector('[data-color-swatch]');
            const rgbLabel = wrapper.querySelector('[data-color-rgb]');
            if (!hexInput || !pickerInput || !swatch || !rgbLabel) return;

            const render = (preferredValue) => {
                const normalized = normalizeHex(preferredValue ?? hexInput.value);
                if (!normalized) {
                    rgbLabel.textContent = 'RGB inválido';
                    swatch.style.backgroundColor = 'transparent';
                    return;
                }
                hexInput.value = normalized;
                pickerInput.value = normalized;
                swatch.style.backgroundColor = normalized;
                rgbLabel.textContent = hexToRgbLabel(normalized);
            };

            pickerInput.addEventListener('input', () => render(pickerInput.value));
            hexInput.addEventListener('input', () => render(hexInput.value));
            hexInput.addEventListener('blur', () => render(hexInput.value));
            render(hexInput.value || pickerInput.value);
        });
    })();
</script>
{% endblock %}
