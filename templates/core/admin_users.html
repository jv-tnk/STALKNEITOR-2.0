{% extends "base.html" %}

{% block content %}
<section class="space-y-6">
    <div class="rounded-2xl border border-slate-800 bg-slate-950/70 p-6">
        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-2xl font-bold text-slate-100">Usuários</h1>
                <p class="text-sm text-slate-400">Gerencie contas (somente superuser).</p>
            </div>
            <div class="flex flex-wrap items-center gap-2 text-sm">
                <a href="{% url 'admin_panel' %}" class="rounded-lg border border-slate-800 bg-slate-900/60 px-3 py-2 text-slate-200 hover:bg-slate-800">Voltar ao painel</a>
                <a href="/admin/auth/user/" target="_blank" class="rounded-lg border border-slate-800 bg-slate-900/60 px-3 py-2 text-slate-200 hover:bg-slate-800">Abrir Painel ADM Raiz</a>
            </div>
        </div>
    </div>

    {% if error %}
        <div class="rounded-xl border border-rose-500/40 bg-rose-500/10 p-4 text-sm text-rose-200">{{ error }}</div>
    {% endif %}
    {% if success %}
        <div class="rounded-xl border border-emerald-500/40 bg-emerald-500/10 p-4 text-sm text-emerald-200">{{ success }}</div>
    {% endif %}

    <div class="rounded-2xl border border-slate-800 bg-slate-950/60 p-4">
        <form method="get" class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
            <label class="block w-full text-xs text-slate-400">
                Buscar
                <input name="q" value="{{ q|default:'' }}" placeholder="username, email, CF handle, AC handle..." class="mt-1 w-full rounded-lg border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500">
            </label>
            <div class="flex gap-2">
                <button type="submit" class="rounded-lg border border-emerald-500/40 bg-emerald-500/15 px-4 py-2 text-sm text-emerald-100 hover:bg-emerald-500/25">
                    Aplicar
                </button>
                <a href="{% url 'admin_users' %}" class="rounded-lg border border-slate-700 bg-slate-900/60 px-4 py-2 text-sm text-slate-200 hover:bg-slate-800">
                    Reset
                </a>
            </div>
        </form>
        <div class="mt-3 text-xs text-slate-500">Total: {{ total_users }} usuários</div>
        <div class="mt-2 flex flex-wrap gap-2 text-xs">
            <span class="rounded-full border border-emerald-500/40 bg-emerald-500/15 px-3 py-1 text-emerald-100">
                Cadastro: {{ source_signup }}
            </span>
            <span class="rounded-full border border-amber-500/40 bg-amber-500/15 px-3 py-1 text-amber-100">
                ADM: {{ source_admin }}
            </span>
            <span class="rounded-full border border-slate-700 bg-slate-800/60 px-3 py-1 text-slate-200">
                Legado: {{ source_legacy }}
            </span>
        </div>
    </div>

    <div class="overflow-hidden rounded-2xl border border-slate-800 bg-slate-950/60">
        <table class="w-full text-sm">
            <thead class="bg-slate-900/70 text-xs text-slate-400">
                <tr>
                    <th class="px-4 py-3 text-left">Usuário</th>
                    <th class="px-4 py-3 text-left">Handles</th>
                    <th class="px-4 py-3 text-left">Origem</th>
                    <th class="px-4 py-3 text-left">Permissões</th>
                    <th class="px-4 py-3 text-right">Ações</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-800">
                {% for u in users_page %}
                    <tr class="bg-slate-950/40">
                        <td class="px-4 py-3">
                            <div class="flex items-center justify-between gap-2">
                                <div class="min-w-0">
                                    <div class="truncate font-semibold text-slate-100">{{ u.username }}</div>
                                    <div class="mt-0.5 truncate text-xs text-slate-500">{{ u.email|default:"" }}</div>
                                </div>
                                <a href="{% url 'user_profile' u.username %}" class="text-xs text-slate-300 hover:text-emerald-200 underline underline-offset-4">
                                    Abrir perfil
                                </a>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-xs text-slate-300">
                            {% if u.profile_obj %}
                                <div>CF: <span class="text-slate-100">{{ u.profile_obj.handle_codeforces|default:"-" }}</span></div>
                                <div>AC: <span class="text-slate-100">{{ u.profile_obj.handle_atcoder|default:"-" }}</span></div>
                            {% else %}
                                <div>CF: <span class="text-slate-100">-</span></div>
                                <div>AC: <span class="text-slate-100">-</span></div>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-xs">
                            <span class="rounded-full border px-3 py-1 {{ u.origin_pill_class }}" title="{{ u.origin_title }}">
                                {{ u.origin_label }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-xs">
                            <div class="flex flex-wrap gap-2">
                                {% if u.is_superuser %}
                                    <span class="rounded-full border border-amber-500/40 bg-amber-500/15 px-3 py-1 text-amber-100">superuser</span>
                                {% endif %}
                                {% if u.is_active %}
                                    <span class="rounded-full border border-emerald-500/40 bg-emerald-500/15 px-3 py-1 text-emerald-100">active</span>
                                {% else %}
                                    <span class="rounded-full border border-rose-500/40 bg-rose-500/10 px-3 py-1 text-rose-100">inactive</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-right">
                            {% if u.id == request.user.id %}
                                <span class="text-xs text-slate-500">Você</span>
                            {% else %}
                                <div class="inline-flex items-center gap-2">
                                    {% if not u.is_superuser %}
                                        <form method="post" action="{% url 'admin_user_promote' u.id %}" class="inline-flex"
                                              onsubmit="return confirm('Promover {{ u.username }} para superuser?');">
                                            {% csrf_token %}
                                            <button type="submit" class="rounded-lg border border-amber-500/40 bg-amber-500/10 px-3 py-2 text-xs font-semibold text-amber-100 hover:bg-amber-500/20">
                                                Promover
                                            </button>
                                        </form>
                                    {% endif %}
                                    <form method="post" action="{% url 'admin_user_delete' u.id %}" class="inline-flex"
                                          onsubmit="return confirm('Remover o usuário {{ u.username }}? Isso apagará PerfilAluno, submissões, score events e soluções relacionadas.');">
                                        {% csrf_token %}
                                        <button type="submit" class="rounded-lg border border-rose-500/40 bg-rose-500/10 px-3 py-2 text-xs font-semibold text-rose-100 hover:bg-rose-500/20">
                                            Remover
                                        </button>
                                    </form>
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="5" class="px-4 py-10 text-center text-sm text-slate-400">Nenhum usuário encontrado.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="flex flex-col items-center gap-3 pt-2">
        <div class="text-sm text-slate-400">
            Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </div>
        <div class="flex flex-wrap justify-center gap-2 text-sm">
            {% if page_obj.has_previous %}
                <a href="?q={{ q|urlencode }}&page={{ page_obj.previous_page_number }}"
                   class="px-3 py-1 rounded-full border border-slate-700 bg-slate-900/60 text-slate-200 hover:text-emerald-200">
                    Anterior
                </a>
            {% endif %}
            {% if page_obj.has_next %}
                <a href="?q={{ q|urlencode }}&page={{ page_obj.next_page_number }}"
                   class="px-3 py-1 rounded-full border border-slate-700 bg-slate-900/60 text-slate-200 hover:text-emerald-200">
                    Próxima
                </a>
            {% endif %}
        </div>
    </div>
</section>
{% endblock %}
