{% extends "base.html" %}

{% block content %}
<section class="space-y-6">
    <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
        <div>
            <div class="flex items-center gap-3">
                <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold {% if platform == 'CF' %}bg-red-500/20 text-red-200 border border-red-500/30{% else %}bg-amber-500/20 text-amber-200 border border-amber-500/30{% endif %}">
                    {{ platform }}
                </span>
                <h2 class="text-2xl font-semibold">{{ contest.title }}</h2>
            </div>
            <div class="mt-1 text-sm text-slate-400">
                {{ contest.start_time|date:"d/m/Y H:i" }}
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-3 text-sm text-slate-300">
            <span class="px-3 py-1 rounded-full border border-slate-700 bg-slate-900/60">
                {{ problems|length }} problemas
            </span>
            {% if platform == 'AC' %}
                <span class="px-3 py-1 rounded-full border border-amber-500/30 bg-amber-500/10 text-amber-200">
                    {{ contest.category }}
                </span>
            {% else %}
                <span class="px-3 py-1 rounded-full border border-red-500/30 bg-red-500/10 text-red-200">
                    {{ contest.division }}
                </span>
            {% endif %}
            <a href="{{ contest_url }}" target="_blank" class="text-emerald-300 hover:text-emerald-200 underline underline-offset-4">
                Abrir contest
            </a>
            {% if request.user.is_authenticated %}
                <button type="button"
                        hx-post="{% url 'force_contest_sync' platform=platform|lower contest_id=contest_id %}?detail=1"
                        hx-target="#contest-force-status"
                        hx-swap="innerHTML"
                        class="rounded-full border border-amber-500/30 bg-amber-500/10 px-3 py-1 text-xs font-semibold text-amber-200 hover:bg-amber-500/20">
                    Forçar update
                </button>
            {% endif %}
        </div>
    </div>

    <div id="contest-force-status"></div>

    <div class="overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/70 shadow-lg shadow-slate-950/30">
        <table class="min-w-full text-sm text-slate-200">
            <thead>
                <tr class="text-left text-xs uppercase tracking-wide text-slate-400 border-b border-slate-800">
                    <th class="py-3 px-4">Problema</th>
                    <th class="py-3 px-4">Rating</th>
                    <th class="py-3 px-4">Tags</th>
                    <th class="py-3 px-4">Solvers</th>
                </tr>
            </thead>
            <tbody>
                {% for problem in problems %}
                    <tr class="border-b border-slate-900">
                        <td class="py-4 px-4 align-top">
                            {% if problem.problem_url %}
                                <a href="{{ problem.problem_url }}" target="_blank" class="text-sm font-semibold hover:text-emerald-300 transition">
                                    {{ problem.index_label }} — {{ problem.name }}
                                </a>
                            {% else %}
                                <div class="text-sm font-semibold">
                                    {{ problem.index_label }} — {{ problem.name }}
                                </div>
                            {% endif %}
                        </td>
                        <td class="py-4 px-4 align-top">
                            <span class="rating-pill px-3 py-1 rounded-full text-xs font-semibold"
                                  style="--rating-color: {{ problem.rating_color }}; --rating-fill: {{ problem.rating_fill }}%; --rating-text: {{ problem.rating_text }};">
                                <span>Rating {{ problem.rating_label }}</span>
                            </span>
                        </td>
                        <td class="py-4 px-4 align-top">
                            <div class="flex flex-wrap gap-2">
                                {% if problem.tags %}
                                    {% for tag in problem.tags %}
                                        <span class="px-2 py-1 rounded-full bg-slate-800/70 text-slate-200 text-[11px] border border-slate-700">
                                            {{ tag }}
                                        </span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-xs text-slate-500">Sem tags</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="py-4 px-4 align-top">
                            <div id="solver-{{ problem.id }}" class="text-xs text-slate-500">
                                Carregando...
                            </div>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td id="contest-no-problems" colspan="4" class="py-6 px-4 text-center text-slate-500">
                            Problemas ainda nao sincronizados para este contest.
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% for offset in chunk_offsets %}
        <div
            hx-get="{% url 'contest_solvers_chunk' platform=platform|lower contest_id=contest_id %}?offset={{ offset }}&limit={{ chunk_size }}&scope=global"
            hx-trigger="load"
            hx-swap="outerHTML">
        </div>
    {% endfor %}

    <div id="contest-solver-refresh-proxy"
         class="hidden"
         data-refresh-url="{{ refresh_chunk_url }}"
         data-refresh-until="{{ detail_refresh_until|default:'' }}">
    </div>
</section>

<script>
    (function () {
        if (window.__contestDetailRefreshInit) {
            return;
        }
        window.__contestDetailRefreshInit = true;

        let timerId = null;

        function stopRefresh() {
            if (timerId) {
                window.clearInterval(timerId);
                timerId = null;
            }
        }

        function scheduleNoProblemsReload(untilMs) {
            const noProblemsCell = document.getElementById("contest-no-problems");
            if (!noProblemsCell) {
                return;
            }
            const until = Number(untilMs || 0);
            if (!until || Number.isNaN(until) || Date.now() >= until) {
                return;
            }
            window.setTimeout(function () {
                if (Date.now() < until) {
                    window.location.reload();
                }
            }, 4000);
        }

        function pollOnce(url) {
            if (!url || typeof htmx === "undefined") {
                return;
            }
            htmx.ajax("GET", url, {
                target: "#contest-solver-refresh-proxy",
                swap: "innerHTML",
            });
        }

        function startRefresh(url, untilMs) {
            stopRefresh();
            const until = Number(untilMs || 0);
            if (!url || !until || Number.isNaN(until)) {
                return;
            }
            const tick = function () {
                if (Date.now() >= until) {
                    stopRefresh();
                    return;
                }
                pollOnce(url);
            };
            tick();
            timerId = window.setInterval(tick, 3000);
        }

        const proxy = document.getElementById("contest-solver-refresh-proxy");
        if (proxy) {
            startRefresh(proxy.dataset.refreshUrl, proxy.dataset.refreshUntil);
            scheduleNoProblemsReload(proxy.dataset.refreshUntil);
        }

        document.body.addEventListener("contest-force-refresh", function (event) {
            const detail = event.detail || {};
            startRefresh(detail.url, detail.until);
            scheduleNoProblemsReload(detail.until);
        });
    })();
</script>
{% endblock %}
