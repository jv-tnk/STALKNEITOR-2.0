{% extends "base.html" %}

{% block content %}
<section class="space-y-6">
    {% include "core/partials/welcome_tour_card.html" %}

    <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
        <div>
            <h2 class="text-2xl font-semibold">Contests</h2>
            <p class="text-slate-400 text-sm">Ano {{ selected_year }}</p>
        </div>
        <div class="flex flex-wrap gap-3 text-sm text-slate-300">
            <div class="px-3 py-2 rounded-lg bg-slate-800/60 border border-slate-700">
                <span class="text-slate-400">Contests</span>
                <span class="font-semibold ml-2">{{ total_contests }}</span>
            </div>
            <div class="px-3 py-2 rounded-lg bg-slate-800/60 border border-slate-700">
                <span class="text-slate-400">Problemas</span>
                <span class="font-semibold ml-2">{{ total_problems }}</span>
            </div>
            <div class="px-3 py-2 rounded-lg bg-slate-800/60 border border-slate-700">
                <span class="text-slate-400">Solves</span>
                <span class="font-semibold ml-2">{{ total_solves }}</span>
            </div>
        </div>
    </div>

    <form method="get" class="grid gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4 md:grid-cols-5">
        <label class="text-xs text-slate-400">
            Plataforma
            <select id="platformFilter" name="platform" class="mt-1 w-full rounded-lg border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm text-slate-100">
                <option value="all" {% if platform_filter == 'all' %}selected{% endif %}>Todas</option>
                <option value="cf" {% if platform_filter == 'cf' %}selected{% endif %}>Codeforces</option>
                <option value="ac" {% if platform_filter == 'ac' %}selected{% endif %}>AtCoder</option>
            </select>
        </label>
        <label class="text-xs text-slate-400">
            Ano
            <select id="year" name="year" class="mt-1 w-full rounded-lg border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm text-slate-100">
                {% for year in available_years %}
                    <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </label>
        <label class="text-xs text-slate-400 {% if platform_filter == 'cf' %}hidden{% endif %}" id="acCategoryWrap">
            Categoria (AtCoder)
            <select name="ac_category" class="mt-1 w-full rounded-lg border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm text-slate-100">
                <option value="all" {% if ac_category == 'all' %}selected{% endif %}>Todas</option>
                {% for category in ac_categories %}
                    <option value="{{ category }}" {% if ac_category == category %}selected{% endif %}>{{ category }}</option>
                {% endfor %}
            </select>
        </label>
        <label class="text-xs text-slate-400 {% if platform_filter == 'ac' %}hidden{% endif %}" id="cfDivisionWrap">
            Divisao (Codeforces)
            <select name="cf_division" class="mt-1 w-full rounded-lg border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm text-slate-100">
                <option value="all" {% if cf_division == 'all' %}selected{% endif %}>Todas</option>
                {% for division in cf_divisions %}
                    <option value="{{ division }}" {% if cf_division == division %}selected{% endif %}>{{ division }}</option>
                {% endfor %}
            </select>
        </label>
        <div class="flex items-end">
            <button type="submit" class="w-full rounded-lg border border-emerald-500/40 bg-emerald-500/20 px-3 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30">
                Aplicar filtros
            </button>
        </div>
    </form>

    {% if contests %}
        <div class="space-y-5">
            {% for row in contests %}
                {% include "core/partials/contest_card.html" with row=row %}
            {% endfor %}
        </div>

        <div class="flex flex-col items-center gap-3 pt-4">
            <div class="text-sm text-slate-400">
                Pagina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
            </div>
            <div class="flex flex-wrap justify-center gap-2">
                {% if page_obj.has_previous %}
                    <a href="?platform={{ platform_filter }}&year={{ selected_year }}&ac_category={{ ac_category }}&cf_division={{ cf_division }}&page={{ page_obj.previous_page_number }}"
                       class="px-3 py-1 rounded-full text-sm border border-slate-700 bg-slate-900/60 text-slate-200 hover:text-emerald-200">
                        Anterior
                    </a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if num == page_obj.number %}
                        <span class="px-3 py-1 rounded-full text-sm border border-emerald-500/40 bg-emerald-500/15 text-emerald-200">
                            {{ num }}
                        </span>
                    {% elif num <= 2 or num > page_obj.paginator.num_pages|add:-2 or num|add:-2 <= page_obj.number and num|add:2 >= page_obj.number %}
                        <a href="?platform={{ platform_filter }}&year={{ selected_year }}&ac_category={{ ac_category }}&cf_division={{ cf_division }}&page={{ num }}"
                           class="px-3 py-1 rounded-full text-sm border border-slate-700 bg-slate-900/60 text-slate-200 hover:text-emerald-200">
                            {{ num }}
                        </a>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <a href="?platform={{ platform_filter }}&year={{ selected_year }}&ac_category={{ ac_category }}&cf_division={{ cf_division }}&page={{ page_obj.next_page_number }}"
                       class="px-3 py-1 rounded-full text-sm border border-slate-700 bg-slate-900/60 text-slate-200 hover:text-emerald-200">
                        Proxima
                    </a>
                {% endif %}
            </div>
        </div>
    {% else %}
        <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-6 text-slate-400">
            Nenhum contest encontrado para {{ selected_year }}.
        </div>
    {% endif %}
</section>

<script>
    const yearSelect = document.getElementById('year');
    const platformSelect = document.getElementById('platformFilter');
    const acWrap = document.getElementById('acCategoryWrap');
    const cfWrap = document.getElementById('cfDivisionWrap');

    const toggleFilters = () => {
        if (!platformSelect) {
            return;
        }
        const platform = platformSelect.value;
        if (acWrap) {
            acWrap.classList.toggle('hidden', platform === 'cf');
        }
        if (cfWrap) {
            cfWrap.classList.toggle('hidden', platform === 'ac');
        }
    };

    if (platformSelect) {
        platformSelect.addEventListener('change', toggleFilters);
    }
    toggleFilters();
</script>
{% endblock %}
