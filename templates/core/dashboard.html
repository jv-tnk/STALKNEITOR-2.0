{% extends 'base.html' %}

{% block content %}
<section class="space-y-6">
    <div class="flex flex-col gap-4 rounded-2xl border border-slate-800 bg-slate-950/70 p-6 md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-3xl font-bold text-slate-100">Dashboard</h1>
            <p class="text-sm text-slate-400">Visão geral de atividade, contests e ranking rápido.</p>
        </div>
        <div class="flex flex-wrap items-center gap-2 text-xs text-slate-400">
            <span class="rounded-full border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 text-emerald-200">
                Atualizado em tempo real
            </span>
            <a href="{% url 'contests_overview' %}" class="rounded-full border border-slate-700 bg-slate-900 px-3 py-1 text-slate-200 hover:text-emerald-200">
                Ver contests
            </a>
            <a href="{% url 'ranking' %}" class="rounded-full border border-slate-700 bg-slate-900 px-3 py-1 text-slate-200 hover:text-indigo-200">
                Abrir ranking
            </a>
        </div>
    </div>

    {% include "core/partials/welcome_tour_card.html" %}

    {% include "core/partials/user_sync_status.html" %}

    <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-5">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
            <div class="text-xs text-slate-500">Alunos cadastrados</div>
            <div class="mt-2 text-3xl font-bold text-slate-100">{{ total_students }}</div>
        </div>
        <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
            <div class="text-xs text-slate-500">Ativos nos últimos 7d</div>
            <div class="mt-2 text-3xl font-bold text-emerald-300">{{ active_students_7d }}</div>
        </div>
        <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
            <div class="text-xs text-slate-500">Solves em 7d</div>
            <div class="mt-2 text-3xl font-bold text-indigo-300">{{ solves_7d }}</div>
        </div>
        <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
            <div class="text-xs text-slate-500">Solves em 30d</div>
            <div class="mt-2 text-3xl font-bold text-slate-100">{{ solves_30d }}</div>
        </div>
        <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
            <div class="text-xs text-slate-500">Solves na temporada</div>
            <div class="mt-2 text-3xl font-bold text-amber-200">{{ solves_season }}</div>
            <div class="mt-1 text-[11px] text-slate-500">
                {% if active_season and active_season.name %}
                    {{ active_season.name }}
                {% elif active_season %}
                    Temporada ativa
                {% else %}
                    Sem temporada ativa
                {% endif %}
            </div>
        </div>
    </div>

    <div class="grid gap-6 lg:grid-cols-3">
        <div class="space-y-6 lg:col-span-2">
            <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-100">Contests recentes</h2>
                        <p class="text-xs text-slate-400">Status de problemas e ratings.</p>
                    </div>
                    <a href="{% url 'contests_overview' %}" class="text-xs text-emerald-300 hover:text-emerald-200">Ver todos</a>
                </div>
                <div class="mt-4 space-y-3">
                    {% for row in contest_rows %}
                        <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-4">
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <div>
                                    <a href="{{ row.detail_url }}" class="text-sm font-semibold text-slate-100 hover:text-emerald-200">
                                        {{ row.contest.title }}
                                    </a>
                                    <div class="text-xs text-slate-500">
                                        {{ row.contest.start_time|date:"d/m/Y H:i" }}
                                    </div>
                                </div>
                                <div class="flex flex-wrap items-center gap-2 text-xs">
                                    <span class="rounded-full border border-slate-700 bg-slate-900 px-3 py-1 text-slate-200">
                                        {{ row.contest.platform }}
                                    </span>
                                    <span class="rounded-full border {% if row.ratings_status == 'READY' %}border-emerald-500/40 bg-emerald-500/15 text-emerald-200{% elif row.ratings_status == 'PARTIAL' %}border-amber-500/40 bg-amber-500/15 text-amber-200{% else %}border-slate-700 bg-slate-800/60 text-slate-300{% endif %} px-3 py-1">
                                        Ratings {{ row.ratings_ready }}/{{ row.problems_total }}
                                    </span>
                                    <a href="{{ row.detail_url }}" class="text-emerald-300 hover:text-emerald-200">Ver detalhes</a>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="h-2 w-full rounded-full bg-slate-800">
                                    <div class="h-2 rounded-full {% if row.ratings_status == 'READY' %}bg-emerald-400{% elif row.ratings_status == 'PARTIAL' %}bg-amber-400{% else %}bg-slate-600{% endif %}" style="width: {{ row.ratings_percent }}%"></div>
                                </div>
                                <div class="mt-2 text-[11px] text-slate-500">
                                    {{ row.ratings_percent }}% ratings prontos
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="text-sm text-slate-400">Nenhum contest encontrado.</div>
                    {% endfor %}
                </div>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-100">Atividade recente</h2>
                        <p class="text-xs text-slate-400">Últimas submissões registradas.</p>
                    </div>
                    <span class="text-xs text-slate-500">Atualiza a cada 30s</span>
                </div>
                <div id="dashboard-activity"
                     hx-get="{% url 'dashboard_activity' %}"
                     hx-trigger="load, every 30s"
                     hx-target="#dashboard-activity"
                     hx-swap="innerHTML">
                    {% include "core/partials/dashboard_activity.html" %}
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
                <h2 class="text-lg font-semibold text-slate-100">Top da temporada</h2>
                <p class="text-xs text-slate-400">
                    Ranking rápido por pontos da temporada
                    {% if active_season and active_season.name %}• {{ active_season.name }}{% endif %}.
                </p>
                <div class="mt-4 space-y-3">
                    {% for row in top_students %}
                        <div class="flex items-center justify-between rounded-lg border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm">
                            <div class="text-slate-200">{{ row.aluno.user.username }}</div>
                            <div class="text-indigo-300 font-semibold">{{ row.season_points_general_cf_equiv|default:0 }}</div>
                        </div>
                    {% empty %}
                        <div class="text-sm text-slate-400">Sem dados suficientes.</div>
                    {% endfor %}
                </div>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
                <h2 class="text-lg font-semibold text-slate-100">Seu resumo</h2>
                {% if my_agg %}
                    <div class="mt-3 space-y-2 text-sm text-slate-300">
                        <div class="flex items-center justify-between">
                            <span>Pontos temporada</span>
                            <span class="text-indigo-300 font-semibold">{{ my_agg.season_points_general_cf_equiv|default:0 }}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span>Pontos CF temporada</span>
                            <span class="text-slate-100 font-semibold">{{ my_agg.season_points_cf_raw|default:0 }}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span>Pontos AC temporada</span>
                            <span class="text-emerald-200 font-semibold">{{ my_agg.season_points_ac_raw|default:0 }}</span>
                        </div>
                    </div>
                {% else %}
                    <p class="mt-3 text-sm text-slate-400">Sem dados pessoais ainda.</p>
                {% endif %}
                <a href="{% url 'ranking' %}" class="mt-4 inline-flex text-xs text-emerald-300 hover:text-emerald-200">
                    Ver minha posição no ranking
                </a>
            </div>

        </div>
    </div>
</section>
{% endblock %}
