<div class="fixed inset-0 z-[120]" aria-modal="true" role="dialog">
    <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeModalRoot()"></div>
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="w-full max-w-4xl rounded-2xl border border-slate-700 bg-slate-900 shadow-2xl">
                <div class="flex items-start justify-between gap-4 border-b border-slate-800 px-6 py-4">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-100">Solução — {{ problem_title }}</h3>
                        <p class="text-xs text-slate-500 break-all">{{ solution.problem_url }}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs px-2 py-1 rounded-full border border-slate-700 bg-slate-800 text-slate-200">
                            {{ solution.get_language_display }}
                        </span>
                        <span class="text-xs px-2 py-1 rounded-full border
                            {% if solution.status == 'approved' %}border-emerald-500/40 text-emerald-300 bg-emerald-500/10
                            {% elif solution.status == 'published' %}border-indigo-500/40 text-indigo-300 bg-indigo-500/10
                            {% else %}border-slate-600 text-slate-300 bg-slate-800{% endif %}">
                            {{ solution.get_status_display }}
                        </span>
                        <button type="button" onclick="closeModalRoot()" class="text-slate-400 hover:text-slate-200">✕</button>
                    </div>
                </div>

                <div class="px-6 py-5">
                    <div class="flex flex-wrap items-center justify-between gap-3 text-xs text-slate-400">
                        <span>Autor: {{ solution.aluno.user.username }}</span>
                        <span>{{ solution.updated_at|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% if solution.idea_summary %}
                        <p class="mt-4 text-sm text-slate-200 whitespace-pre-wrap">{{ solution.idea_summary }}</p>
                    {% endif %}
                    {% if solution.code_text %}
                        <div class="mt-4 flex">
                            <div id="solution-view-line-nums" class="select-none pr-3 text-right text-[11px] leading-5 text-slate-500 whitespace-pre"></div>
                            <pre class="flex-1 overflow-x-auto rounded-lg border border-slate-800 bg-slate-950 p-4 text-[11px] leading-5 text-slate-100"><code id="solution-view-code" class="{{ hljs_class }}">{{ solution.code_text }}</code></pre>
                        </div>
                    {% else %}
                        <p class="mt-4 text-xs text-slate-500">Sem código compartilhado.</p>
                    {% endif %}
                </div>

                <div class="flex items-center justify-between border-t border-slate-800 px-6 py-4">
                    <div class="text-xs text-slate-500">
                        Linguagem: {{ solution.get_language_display }} | Visibilidade: {{ solution.get_visibility_display }}
                    </div>
                    <div class="flex gap-2">
                        {% if solution.code_text %}
                            <button type="button" id="solution-copy-btn" class="rounded-lg border border-slate-700 bg-slate-800 px-4 py-2 text-xs font-semibold text-slate-200 hover:bg-slate-700">
                                Copiar
                            </button>
                        {% endif %}
                        {% if can_edit %}
                            <button
                                hx-get="{% url 'solutions_modal' %}?problem_url={{ solution.problem_url|urlencode }}&contest_id={{ solution.contest_id|default_if_none:'' }}&platform={{ solution.platform_context|default_if_none:'' }}"
                                hx-target="#modal-root"
                                hx-swap="innerHTML"
                                class="rounded-lg border border-slate-700 bg-slate-800 px-4 py-2 text-xs font-semibold text-slate-200 hover:bg-slate-700"
                            >
                                Editar
                            </button>
                        {% endif %}
                        {% if request.user.is_staff and solution.status != "approved" %}
                            <form hx-post="{% url 'solutions_approve' %}" hx-target="#modal-root" hx-swap="innerHTML">
                                {% csrf_token %}
                                <input type="hidden" name="solution_id" value="{{ solution.id }}">
                                <button type="submit" class="rounded-lg bg-emerald-600 px-4 py-2 text-xs font-semibold text-white hover:bg-emerald-500">
                                    Aprovar
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    (() => {
        const codeEl = document.getElementById('solution-view-code');
        const lineNums = document.getElementById('solution-view-line-nums');
        const copyBtn = document.getElementById('solution-copy-btn');
        if (codeEl && lineNums) {
            const lines = Math.max(1, codeEl.textContent.split('\n').length);
            lineNums.textContent = Array.from({ length: lines }, (_, i) => i + 1).join('\n');
        }
        if (copyBtn && codeEl) {
            copyBtn.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(codeEl.textContent);
                    copyBtn.textContent = 'Copiado!';
                    setTimeout(() => {
                        copyBtn.textContent = 'Copiar';
                    }, 1200);
                } catch (err) {
                    copyBtn.textContent = 'Falhou';
                    setTimeout(() => {
                        copyBtn.textContent = 'Copiar';
                    }, 1200);
                }
            });
        }
    })();
</script>
